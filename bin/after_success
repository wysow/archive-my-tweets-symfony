#!/usr/bin/env bash
cd "$(dirname "$0")/.."

have() { command -v "$1" >/dev/null 2>&1; }

if [[ "$TRAVIS" == "true" ]]; then
  if [[ "$TRAVIS_PULL_REQUEST" != "false" ]]; then
    echo "This is a pull request. No deployment will be done."
    exit 0
  fi
  if [[ "$TRAVIS_BRANCH" != "master" ]]; then
    echo "Testing on a branch other than master. No deployment will be done."
    exit 0
  fi

  gem install pagoda
fi

if ! have pagoda; then
  echo "The Pagoda gem file is not installed. Please install it."
  exit 1
fi

ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa -C "travis-deployment"

yes | pagoda -u $PAGODA_USERNAME -p $PAGODA_PASSWORD key:push
yes | git remote add pagoda git@git.pagodabox.com:archive-my-tweets-wysow-fr.git
yes | git push pagoda master